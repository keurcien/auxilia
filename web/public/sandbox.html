<!doctype html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>MCP App Sandbox</title>
		<style>
			html,
			body {
				margin: 0;
				padding: 0;
				width: 100%;
				height: 100%;
				overflow: hidden;
				background: transparent;
			}

			#mcp-app-frame {
				width: 100%;
				height: 100%;
				border: 0;
				background: transparent;
			}
		</style>
	</head>
	<body>
		<iframe
			id="mcp-app-frame"
			title="MCP App"
			sandbox="allow-scripts allow-same-origin allow-forms"
		></iframe>
		<script>
			(() => {
				const SANDBOX_PROXY_READY = "ui/notifications/sandbox-proxy-ready";
				const SANDBOX_RESOURCE_READY =
					"ui/notifications/sandbox-resource-ready";

				const frame = document.getElementById("mcp-app-frame");
				if (!(frame instanceof HTMLIFrameElement)) {
					return;
				}

				const postToParent = (data) => {
					window.parent.postMessage(data, "*");
				};

				const postToApp = (data) => {
					if (!frame.contentWindow) {
						return;
					}
					frame.contentWindow.postMessage(data, "*");
				};

				const loadResource = (params) => {
					if (
						!params ||
						typeof params !== "object" ||
						typeof params.html !== "string"
					) {
						return;
					}

					const sandboxPermissions =
						typeof params.sandbox === "string" && params.sandbox.trim()
							? params.sandbox
							: "allow-scripts allow-same-origin allow-forms";
					frame.setAttribute("sandbox", sandboxPermissions);
					frame.srcdoc = params.html;
				};

				window.addEventListener("message", (event) => {
					if (event.source === window.parent) {
						const message = event.data;
						if (!message || typeof message !== "object") {
							return;
						}

						if (message.method === SANDBOX_RESOURCE_READY) {
							loadResource(message.params);
							return;
						}

						postToApp(message);
						return;
					}

					if (event.source === frame.contentWindow) {
						postToParent(event.data);
					}
				});

				postToParent({
					jsonrpc: "2.0",
					method: SANDBOX_PROXY_READY,
					params: {},
				});
			})();
		</script>
	</body>
</html>
